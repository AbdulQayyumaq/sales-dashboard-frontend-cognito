"use strict";exports.id=55,exports.ids=[55,624],exports.modules={3624:(e,t,r)=>{r.d(t,{fromSSO:()=>b});var s=r(558),i=r(697),o=r(3733),n=r(4058),a=r(4672),l=r(6632);let g=e=>Object.entries(e).filter(([e])=>e.startsWith(a.I.SSO_SESSION+l.C)).reduce((e,[t,r])=>({...e,[t.substring(t.indexOf(l.C)+1)]:r}),{});var c=r(8628),f=r(8479);let p=()=>({}),h=async(e={})=>(0,f.pJ)(e.configFilepath??(0,n.f)()).then(c.V).then(g).catch(p),w=e=>e&&("string"==typeof e.sso_start_url||"string"==typeof e.sso_account_id||"string"==typeof e.sso_session||"string"==typeof e.sso_region||"string"==typeof e.sso_role_name);var d=r(7529),u=r(6148);class S extends u.k{constructor(e,t=!0){super(e,t),this.name="TokenProviderError",Object.setPrototypeOf(this,S.prototype)}}var m=r(4903);let _="To refresh this SSO session run 'aws sso login' with the corresponding profile.",k=async(e,t={})=>{let{SSOOIDCClient:s}=await Promise.all([r.e(596),r.e(989)]).then(r.bind(r,5989)),i=e=>t.clientConfig?.[e]??t.parentClientConfig?.[e];return new s(Object.assign({},t.clientConfig??{},{region:e??t.clientConfig?.region,logger:i("logger"),userAgentAppId:i("userAgentAppId")}))},y=async(e,t,s={})=>{let{CreateTokenCommand:i}=await Promise.all([r.e(596),r.e(989)]).then(r.bind(r,5989));return(await k(t,s)).send(new i({clientId:e.clientId,clientSecret:e.clientSecret,refreshToken:e.refreshToken,grantType:"refresh_token"}))},C=e=>{if(e.expiration&&e.expiration.getTime()<Date.now())throw new S(`Token is expired. ${_}`,!1)},x=(e,t,r=!1)=>{if(void 0===t)throw new S(`Value not present for '${e}' in SSO Token${r?". Cannot refresh":""}. ${_}`,!1)};var O=r(9554);let{writeFile:T}=r(7147).promises,I=(e,t)=>T((0,O.P)(e),JSON.stringify(t,null,2)),A=new Date(0),$=(e={})=>async({callerClientConfig:t}={})=>{let r;let s={...e,parentClientConfig:{...t,...e.parentClientConfig}};s.logger?.debug("@aws-sdk/token-providers - fromSso");let n=await (0,o.M)(s),a=(0,i.Jl)({profile:s.profile??t?.profile}),l=n[a];if(l){if(!l.sso_session)throw new S(`Profile '${a}' is missing required property 'sso_session'.`)}else throw new S(`Profile '${a}' could not be found in shared credentials file.`,!1);let g=l.sso_session,c=(await h(s))[g];if(!c)throw new S(`Sso session '${g}' could not be found in shared credentials file.`,!1);for(let e of["sso_start_url","sso_region"])if(!c[e])throw new S(`Sso session '${g}' is missing required property '${e}'.`,!1);c.sso_start_url;let f=c.sso_region;try{r=await (0,m.g)(g)}catch(e){throw new S(`The SSO session token associated with profile=${a} was not found or is invalid. ${_}`,!1)}x("accessToken",r.accessToken),x("expiresAt",r.expiresAt);let{accessToken:p,expiresAt:w}=r,d={token:p,expiration:new Date(w)};if(d.expiration.getTime()-Date.now()>3e5)return d;if(Date.now()-A.getTime()<3e4)return C(d),d;x("clientId",r.clientId,!0),x("clientSecret",r.clientSecret,!0),x("refreshToken",r.refreshToken,!0);try{A.setTime(Date.now());let e=await y(r,f,s);x("accessToken",e.accessToken),x("expiresIn",e.expiresIn);let t=new Date(Date.now()+1e3*e.expiresIn);try{await I(g,{...r,accessToken:e.accessToken,expiresAt:t.toISOString(),refreshToken:e.refreshToken})}catch(e){}return{token:e.accessToken,expiration:t}}catch(e){return C(d),d}},v=async({ssoStartUrl:e,ssoSession:t,ssoAccountId:i,ssoRegion:o,ssoRoleName:n,ssoClient:a,clientConfig:l,parentClientConfig:g,profile:c,filepath:f,configFilepath:p,ignoreCache:h,logger:w})=>{let u,S;let _="To refresh this SSO session run aws sso login with the corresponding profile.";if(t)try{let e=await $({profile:c,filepath:f,configFilepath:p,ignoreCache:h})();u={accessToken:e.token,expiresAt:new Date(e.expiration).toISOString()}}catch(e){throw new s.m(e.message,{tryNextLink:!1,logger:w})}else try{u=await (0,m.g)(e)}catch(e){throw new s.m(`The SSO session associated with this profile is invalid. ${_}`,{tryNextLink:!1,logger:w})}if(new Date(u.expiresAt).getTime()-Date.now()<=0)throw new s.m(`The SSO session associated with this profile has expired. ${_}`,{tryNextLink:!1,logger:w});let{accessToken:k}=u,{SSOClient:y,GetRoleCredentialsCommand:C}=await Promise.all([r.e(596),r.e(540)]).then(r.bind(r,5540)),x=a||new y(Object.assign({},l??{},{logger:l?.logger??g?.logger,region:l?.region??o,userAgentAppId:l?.userAgentAppId??g?.userAgentAppId}));try{S=await x.send(new C({accountId:i,roleName:n,accessToken:k}))}catch(e){throw new s.m(e,{tryNextLink:!1,logger:w})}let{roleCredentials:{accessKeyId:O,secretAccessKey:T,sessionToken:I,expiration:A,credentialScope:v,accountId:N}={}}=S;if(!O||!T||!I||!A)throw new s.m("SSO returns an invalid temporary credential.",{tryNextLink:!1,logger:w});let b={accessKeyId:O,secretAccessKey:T,sessionToken:I,expiration:new Date(A),...v&&{credentialScope:v},...N&&{accountId:N}};return t?(0,d.P)(b,"CREDENTIALS_SSO","s"):(0,d.P)(b,"CREDENTIALS_SSO_LEGACY","u"),b},N=(e,t)=>{let{sso_start_url:r,sso_account_id:i,sso_region:o,sso_role_name:n}=e;if(!r||!i||!o||!n)throw new s.m(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", "sso_role_name", "sso_start_url". Got ${Object.keys(e).join(", ")}
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`,{tryNextLink:!1,logger:t});return e},b=(e={})=>async({callerClientConfig:t}={})=>{e.logger?.debug("@aws-sdk/credential-provider-sso - fromSSO");let{ssoStartUrl:r,ssoAccountId:n,ssoRegion:a,ssoRoleName:l,ssoSession:g}=e,{ssoClient:c}=e,f=(0,i.Jl)({profile:e.profile??t?.profile});if(r||n||a||l||g){if(r&&n&&a&&l)return v({ssoStartUrl:r,ssoSession:g,ssoAccountId:n,ssoRegion:a,ssoRoleName:l,ssoClient:c,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:f,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger});throw new s.m('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl", "ssoAccountId", "ssoRegion", "ssoRoleName"',{tryNextLink:!1,logger:e.logger})}{let t=(await (0,o.M)(e))[f];if(!t)throw new s.m(`Profile ${f} was not found.`,{logger:e.logger});if(!w(t))throw new s.m(`Profile ${f} is not configured with SSO credentials.`,{logger:e.logger});if(t?.sso_session){let i=(await h(e))[t.sso_session],o=` configurations in profile ${f} and sso-session ${t.sso_session}`;if(a&&a!==i.sso_region)throw new s.m("Conflicting SSO region"+o,{tryNextLink:!1,logger:e.logger});if(r&&r!==i.sso_start_url)throw new s.m("Conflicting SSO start_url"+o,{tryNextLink:!1,logger:e.logger});t.sso_region=i.sso_region,t.sso_start_url=i.sso_start_url}let{sso_start_url:i,sso_account_id:n,sso_region:l,sso_role_name:g,sso_session:p}=N(t,e.logger);return v({ssoStartUrl:i,ssoSession:p,ssoAccountId:n,ssoRegion:l,ssoRoleName:g,ssoClient:c,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:f,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}}},9554:(e,t,r)=>{r.d(t,{P:()=>n});var s=r(6113),i=r(1017),o=r(6789);let n=e=>{let t=(0,s.createHash)("sha1").update(e).digest("hex");return(0,i.join)((0,o.O)(),".aws","sso","cache",`${t}.json`)}},4903:(e,t,r)=>{r.d(t,{g:()=>n,l:()=>o});var s=r(3292),i=r(9554);let o={},n=async e=>{if(o[e])return o[e];let t=(0,i.P)(e);return JSON.parse(await (0,s.readFile)(t,"utf8"))}},3733:(e,t,r)=>{r.d(t,{M:()=>o});var s=r(6201);let i=(...e)=>{let t={};for(let r of e)for(let[e,s]of Object.entries(r))void 0!==t[e]?Object.assign(t[e],s):t[e]=s;return t},o=async e=>{let t=await (0,s.Z)(e);return i(t.configFile,t.credentialsFile)}}};