"use strict";exports.id=624,exports.ids=[624],exports.modules={3624:(e,t,s)=>{s.d(t,{fromSSO:()=>P});var r=s(558),i=s(697),o=s(3733),n=s(4058),a=s(4672),l=s(6632);let g=e=>Object.entries(e).filter(([e])=>e.startsWith(a.I.SSO_SESSION+l.C)).reduce((e,[t,s])=>({...e,[t.substring(t.indexOf(l.C)+1)]:s}),{});var c=s(8628),f=s(8479);let p=()=>({}),h=async(e={})=>(0,f.pJ)(e.configFilepath??(0,n.f)()).then(c.V).then(g).catch(p),w=e=>e&&("string"==typeof e.sso_start_url||"string"==typeof e.sso_account_id||"string"==typeof e.sso_session||"string"==typeof e.sso_region||"string"==typeof e.sso_role_name);var d=s(7529),u=s(6148);class S extends u.k{constructor(e,t=!0){super(e,t),this.name="TokenProviderError",Object.setPrototypeOf(this,S.prototype)}}var m=s(4903);let _="To refresh this SSO session run 'aws sso login' with the corresponding profile.",k=async(e,t={})=>{let{SSOOIDCClient:r}=await Promise.all([s.e(596),s.e(989)]).then(s.bind(s,5989)),i=e=>t.clientConfig?.[e]??t.parentClientConfig?.[e];return new r(Object.assign({},t.clientConfig??{},{region:e??t.clientConfig?.region,logger:i("logger"),userAgentAppId:i("userAgentAppId")}))},y=async(e,t,r={})=>{let{CreateTokenCommand:i}=await Promise.all([s.e(596),s.e(989)]).then(s.bind(s,5989));return(await k(t,r)).send(new i({clientId:e.clientId,clientSecret:e.clientSecret,refreshToken:e.refreshToken,grantType:"refresh_token"}))},C=e=>{if(e.expiration&&e.expiration.getTime()<Date.now())throw new S(`Token is expired. ${_}`,!1)},x=(e,t,s=!1)=>{if(void 0===t)throw new S(`Value not present for '${e}' in SSO Token${s?". Cannot refresh":""}. ${_}`,!1)};var T=s(9554);let{writeFile:O}=s(7147).promises,I=(e,t)=>O((0,T.P)(e),JSON.stringify(t,null,2)),A=new Date(0),$=(e={})=>async({callerClientConfig:t}={})=>{let s;let r={...e,parentClientConfig:{...t,...e.parentClientConfig}};r.logger?.debug("@aws-sdk/token-providers - fromSso");let n=await (0,o.M)(r),a=(0,i.Jl)({profile:r.profile??t?.profile}),l=n[a];if(l){if(!l.sso_session)throw new S(`Profile '${a}' is missing required property 'sso_session'.`)}else throw new S(`Profile '${a}' could not be found in shared credentials file.`,!1);let g=l.sso_session,c=(await h(r))[g];if(!c)throw new S(`Sso session '${g}' could not be found in shared credentials file.`,!1);for(let e of["sso_start_url","sso_region"])if(!c[e])throw new S(`Sso session '${g}' is missing required property '${e}'.`,!1);c.sso_start_url;let f=c.sso_region;try{s=await (0,m.g)(g)}catch(e){throw new S(`The SSO session token associated with profile=${a} was not found or is invalid. ${_}`,!1)}x("accessToken",s.accessToken),x("expiresAt",s.expiresAt);let{accessToken:p,expiresAt:w}=s,d={token:p,expiration:new Date(w)};if(d.expiration.getTime()-Date.now()>3e5)return d;if(Date.now()-A.getTime()<3e4)return C(d),d;x("clientId",s.clientId,!0),x("clientSecret",s.clientSecret,!0),x("refreshToken",s.refreshToken,!0);try{A.setTime(Date.now());let e=await y(s,f,r);x("accessToken",e.accessToken),x("expiresIn",e.expiresIn);let t=new Date(Date.now()+1e3*e.expiresIn);try{await I(g,{...s,accessToken:e.accessToken,expiresAt:t.toISOString(),refreshToken:e.refreshToken})}catch(e){}return{token:e.accessToken,expiration:t}}catch(e){return C(d),d}},N=async({ssoStartUrl:e,ssoSession:t,ssoAccountId:i,ssoRegion:o,ssoRoleName:n,ssoClient:a,clientConfig:l,parentClientConfig:g,profile:c,filepath:f,configFilepath:p,ignoreCache:h,logger:w})=>{let u,S;let _="To refresh this SSO session run aws sso login with the corresponding profile.";if(t)try{let e=await $({profile:c,filepath:f,configFilepath:p,ignoreCache:h})();u={accessToken:e.token,expiresAt:new Date(e.expiration).toISOString()}}catch(e){throw new r.m(e.message,{tryNextLink:!1,logger:w})}else try{u=await (0,m.g)(e)}catch(e){throw new r.m(`The SSO session associated with this profile is invalid. ${_}`,{tryNextLink:!1,logger:w})}if(new Date(u.expiresAt).getTime()-Date.now()<=0)throw new r.m(`The SSO session associated with this profile has expired. ${_}`,{tryNextLink:!1,logger:w});let{accessToken:k}=u,{SSOClient:y,GetRoleCredentialsCommand:C}=await Promise.all([s.e(596),s.e(540)]).then(s.bind(s,5540)),x=a||new y(Object.assign({},l??{},{logger:l?.logger??g?.logger,region:l?.region??o,userAgentAppId:l?.userAgentAppId??g?.userAgentAppId}));try{S=await x.send(new C({accountId:i,roleName:n,accessToken:k}))}catch(e){throw new r.m(e,{tryNextLink:!1,logger:w})}let{roleCredentials:{accessKeyId:T,secretAccessKey:O,sessionToken:I,expiration:A,credentialScope:N,accountId:v}={}}=S;if(!T||!O||!I||!A)throw new r.m("SSO returns an invalid temporary credential.",{tryNextLink:!1,logger:w});let P={accessKeyId:T,secretAccessKey:O,sessionToken:I,expiration:new Date(A),...N&&{credentialScope:N},...v&&{accountId:v}};return t?(0,d.P)(P,"CREDENTIALS_SSO","s"):(0,d.P)(P,"CREDENTIALS_SSO_LEGACY","u"),P},v=(e,t)=>{let{sso_start_url:s,sso_account_id:i,sso_region:o,sso_role_name:n}=e;if(!s||!i||!o||!n)throw new r.m(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", "sso_role_name", "sso_start_url". Got ${Object.keys(e).join(", ")}
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`,{tryNextLink:!1,logger:t});return e},P=(e={})=>async({callerClientConfig:t}={})=>{e.logger?.debug("@aws-sdk/credential-provider-sso - fromSSO");let{ssoStartUrl:s,ssoAccountId:n,ssoRegion:a,ssoRoleName:l,ssoSession:g}=e,{ssoClient:c}=e,f=(0,i.Jl)({profile:e.profile??t?.profile});if(s||n||a||l||g){if(s&&n&&a&&l)return N({ssoStartUrl:s,ssoSession:g,ssoAccountId:n,ssoRegion:a,ssoRoleName:l,ssoClient:c,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:f,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger});throw new r.m('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl", "ssoAccountId", "ssoRegion", "ssoRoleName"',{tryNextLink:!1,logger:e.logger})}{let t=(await (0,o.M)(e))[f];if(!t)throw new r.m(`Profile ${f} was not found.`,{logger:e.logger});if(!w(t))throw new r.m(`Profile ${f} is not configured with SSO credentials.`,{logger:e.logger});if(t?.sso_session){let i=(await h(e))[t.sso_session],o=` configurations in profile ${f} and sso-session ${t.sso_session}`;if(a&&a!==i.sso_region)throw new r.m("Conflicting SSO region"+o,{tryNextLink:!1,logger:e.logger});if(s&&s!==i.sso_start_url)throw new r.m("Conflicting SSO start_url"+o,{tryNextLink:!1,logger:e.logger});t.sso_region=i.sso_region,t.sso_start_url=i.sso_start_url}let{sso_start_url:i,sso_account_id:n,sso_region:l,sso_role_name:g,sso_session:p}=v(t,e.logger);return N({ssoStartUrl:i,ssoSession:p,ssoAccountId:n,ssoRegion:l,ssoRoleName:g,ssoClient:c,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:f,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}}},9554:(e,t,s)=>{s.d(t,{P:()=>n});var r=s(6113),i=s(1017),o=s(6789);let n=e=>{let t=(0,r.createHash)("sha1").update(e).digest("hex");return(0,i.join)((0,o.O)(),".aws","sso","cache",`${t}.json`)}},4903:(e,t,s)=>{s.d(t,{g:()=>n,l:()=>o});var r=s(3292),i=s(9554);let o={},n=async e=>{if(o[e])return o[e];let t=(0,i.P)(e);return JSON.parse(await (0,r.readFile)(t,"utf8"))}}};